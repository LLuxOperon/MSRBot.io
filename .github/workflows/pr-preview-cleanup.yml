name: PR Preview Cleanup

on:
  pull_request:
    types: [closed]

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  cleanup:
    # Only for PRs from this repo (matches your preview guard)
    if: github.event.pull_request.head.repo.full_name == github.repository
    runs-on: ubuntu-latest
    steps:
      - name: Mint PrZ3 Unit token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: Checkout gh-pages branch
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          token: ${{ steps.app-token.outputs.token }}

      - name: Remove pr/<PR#> directory
        run: |
          set -e
          TARGET="pr/${{ github.event.number }}"
          if [ -d "$TARGET" ]; then
            git rm -r "$TARGET"
          else
            echo "No preview dir to remove: $TARGET"
          fi

      - name: Commit and push removal (if any)
        run: |
          set -e
          git config user.name "PrZ3 Unit"
          git config user.email "prz3-unit[bot]@users.noreply.github.com"
          if ! git diff --cached --quiet; then
            git commit -m "Cleanup preview for PR #${{ github.event.number }}"
            git push origin gh-pages
          else
            echo "Nothing to commit."
          fi

      - name: Update PR comment to mark preview removed
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}
          header: msr-preview
          message: |
            Preview removed (PR closed):
            [MSRBot.io Build Preview](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/pr/${{ github.event.number }}/)

            _This URL should now return 404 (directory deleted)._